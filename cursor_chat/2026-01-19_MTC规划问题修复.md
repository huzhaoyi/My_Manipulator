# MTC规划问题修复 + 关节限制更新

日期：2026-01-19

## 问题描述

### 问题1: yaw方向不变
- **现象**：网页下发不同的yaw（0°、90°、180°），但夹爪方向始终不变（约68°）
- **根本原因**：代码第6595-6605行用IK解的Joint1值覆盖了用户指定的joint1_target
- **修复**：反过来用用户指定的joint1_target覆盖IK解的Joint1

### 问题2: Invalid Start State导致首次规划失败
- **现象**：第一次抓取任务失败（Skipping invalid start state），第二次成功
- **根本原因**：FixedState构造时没有调用enforceBounds()，浮点误差导致状态被判为invalid
- **修复**：在FixedState的start.update()后添加start.enforceBounds()

### 问题3: 关节限位边界值误判
- **现象**：Joint3值-1.570被误判为超出限位[-1.570, 0.000]
- **根本原因**：严格比较`<`/`>`导致边界值被误判
- **修复**：添加小容差（1e-4 rad ≈ 0.006°）

### 问题4: 全零状态规划频繁失败
- **现象**：机械臂从全零状态开始时规划经常失败
- **根本原因**：全零状态接近奇异点，RRT规划困难
- **修复**：添加预运动功能，自动移动到安全预备位置后再执行MTC任务

## 修改文件

### 1. src/m5_grasp/src/m5_grasp.cpp

#### 修复yaw被覆盖的问题（约第6595行）
```cpp
// 原来：用IK解覆盖joint1_target
joint1_target = ik_joint1;

// 修复：用用户指定的joint1_target覆盖IK解的Joint1
pregrasp_joint_map["Joint1"] = joint1_target;
```

#### 添加enforceBounds()调用
- FixedState stage（grasp任务，约第6571行）
- FixedState stage（place任务，约第7489行）
- getCurrentStateSafe()函数
- setStartStateExplicit()函数
- 其他构建RobotState的位置

#### 添加关节限位容差（3处）
```cpp
const double JOINT_LIMIT_TOLERANCE = 1e-4;
if (joint_value < min_bound - JOINT_LIMIT_TOLERANCE || joint_value > max_bound + JOINT_LIMIT_TOLERANCE)
```

#### 添加预运动功能
- 新增参数：auto_move_to_ready, ready_joint1~4, near_zero_threshold
- 新增函数：check_near_zero_state(), move_to_ready_position()
- 在do_cable_grasp_mtc()开头添加预运动逻辑

### 2. src/m5_grasp/config/cable_grasp.yaml

添加预运动参数：
```yaml
grasp:
  auto_move_to_ready: true
  ready_joint1: 0.0
  ready_joint2: -0.5
  ready_joint3: -0.5
  ready_joint4: 0.0
  near_zero_threshold: 0.1
```

## 验证步骤

1. 编译代码：`colcon build --packages-select m5_grasp`
2. 测试yaw控制：发送不同yaw值，确认夹爪方向正确响应
3. 测试全零状态：机械臂从全零状态开始，确认自动移动到预备位置
4. 测试边界值：发送Joint3接近-90°的任务，确认不再报限位警告
5. 连续测试：连续发送多个任务，确认首次及后续都能成功

---

## 关节限制更新

### 厂家新限制（2026-01-19）

| 关节 | 旧限制 (rad) | 旧限制 (deg) | 新限制 (deg) | 新限制 (rad) |
|------|-------------|-------------|-------------|-------------|
| Joint1 | [-3.14, 3.14] | [-180°, 180°] | [-355°, 355°] | [-6.20, 6.20] |
| Joint2 | [-1.57, 0] | [-90°, 0°] | [-170°, 0°] | [-2.97, 0] |
| Joint3 | [-1.57, 0] | [-90°, 0°] | [-170°, 0°] | [-2.97, 0] |
| Joint4 | [-3.14, 3.14] | [-180°, 180°] | [-355°, 355°] | [-6.20, 6.20] |

### 修改文件

1. **URDF**: `src/m5/urdf/m5_updated_from_csv.urdf`
   - 更新Joint1~4的limit标签

2. **代码**: `src/m5_grasp/src/m5_grasp.cpp`
   - 更新`check_joint23_reachable()`函数中的硬编码限制
   - 更新所有相关注释和日志

3. **配置文件**:
   - `src/m5_configure/config/kinematics.yaml` - 更新注释
   - `src/m5_configure/config/ompl_planning.yaml` - 更新注释
   - `src/m5_configure/src/m5_planning.cpp` - 更新注释

4. **文档**: `src/m5_configure/docs/workspace_reachable_positions.md`
   - 更新关节限制说明

### 影响

- **工作空间扩大**：Joint2/3从±90°扩展到-170°，工作范围显著增加
- **Joint1/4可旋转近两圈**：从±180°扩展到±355°，避免绕线问题
