# FSMæŠ“å–çŠ¶æ€æœºæ”¹é€ 

## æ—¥æœŸ
2026-01-21

## é—®é¢˜æè¿°
åŸæœ‰çš„æŠ“å–å®ç°å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. å›è°ƒçº¿ç¨‹è¢«é•¿æ—¶é—´å ç”¨ï¼ˆç›®æ ‡åˆ·æ–°ã€æ€¥åœã€å¯è§†åŒ–éƒ½ä¼šå—å½±å“ï¼‰
2. éš¾ä»¥å®ç°FSMï¼ˆåˆ†æ®µ/é‡è¯•/reacquire/å›é€€ï¼‰
3. `create_grasp_task_mtc()` æ˜¯ä¸€ä¸ª"å·¨å‹Task"ï¼ˆæŠŠpregrasp/ç¢°æ’ä½“/æ¥è¿‘/ä¸‹æ¢/æŠ“å–éƒ½å¡ä¸€èµ·ï¼‰ï¼Œä¸€æ—¦ä¸­é—´å¤±è´¥æ²¡æ³•ä¼˜é›…é‡æ¥

## è§£å†³æ–¹æ¡ˆ
å®ç°FSMï¼ˆæœ‰é™çŠ¶æ€æœºï¼‰é©±åŠ¨çš„æŠ“å–æµç¨‹ï¼š

### 1. æ–°å¢FSMçŠ¶æ€æšä¸¾
```cpp
enum class GraspFSMState {
  IDLE,                 // ç©ºé—²çŠ¶æ€ï¼Œç­‰å¾…ç›®æ ‡
  WAIT_TARGET_STABLE,   // ç­‰å¾…ç›®æ ‡ç¨³å®š
  OPEN_GRIPPER,         // æ‰“å¼€å¤¹çˆªï¼ˆå‡†å¤‡é˜¶æ®µï¼‰
  PREGRASP,             // ç§»åŠ¨åˆ°é¢„æŠ“å–ä½ç½®
  ALIGN,                // å¯¹é½å§¿æ€ï¼ˆyawå¯¹é½ç¼†ç»³ï¼‰
  DESCEND,              // ç¬›å¡å°”ä¸‹æ¢
  CLOSE_GRIPPER,        // é—­åˆå¤¹çˆª
  LIFT,                 // ç¬›å¡å°”æŠ¬å‡
  DONE,                 // å®Œæˆ
  ABORT_SAFE,           // å®‰å…¨ä¸­æ­¢ï¼ˆå›å®‰å…¨ä½/æ¾çˆªï¼‰
  RETRY_BACKOFF         // é‡è¯•å›é€€
};
```

### 2. å›è°ƒå‡½æ•°æ”¹é€ 
å°† `cable_pose_with_yaw_callback()` ä»"æ¥æ”¶å³æ‰§è¡Œ"æ”¹ä¸º"åªæ›´æ–°ç›®æ ‡+æ¨å…¥æ»‘çª—"æ¨¡å¼ï¼š
- æ›´æ–° `fsm_latest_target_` å’Œ `fsm_latest_target_time_`
- æ¨å…¥æ»‘çª—ç”¨äºç¨³å®šæ€§åˆ¤æ–­
- å¦‚æœFSMå¤„äºIDLEï¼Œåˆ‡æ¢åˆ°WAIT_TARGET_STABLE

### 3. ç›®æ ‡ç¨³å®šæ€§åˆ¤å®š
`fsm_target_is_stable()` å‡½æ•°æ£€æŸ¥ï¼š
- æ»‘çª—å†…è‡³å°‘æœ‰5å¸§
- ç›®æ ‡æ—¶é—´æˆ³æ–°é²œåº¦ < 0.5s
- ä½ç½®æœ€å¤§åç§» < 1cm
- yawæœ€å¤§åç§» < 5åº¦

### 4. FSMå®šæ—¶å™¨é©±åŠ¨
- 10Hzå®šæ—¶å™¨ (`fsm_timer_`) é©±åŠ¨çŠ¶æ€æœº
- æ¯100msæ‰§è¡Œä¸€æ¬¡ `fsm_tick()`
- æ ¹æ®å½“å‰çŠ¶æ€å†³å®šä¸‹ä¸€æ­¥åŠ¨ä½œ

### 5. æ‹†åˆ†ä¸ºå°Task
åŸæ¥çš„å·¨å‹Taskè¢«æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å°ä»»åŠ¡ï¼š
- `fsm_run_open_gripper()`: æ‰“å¼€å¤¹çˆª
- `fsm_run_pregrasp()`: ç§»åŠ¨åˆ°é¢„æŠ“å–ä½ç½®
- `fsm_run_align()`: å¯¹é½å§¿æ€ï¼ˆè®¾ç½®Joint4ï¼‰
- `fsm_run_descend()`: ç¬›å¡å°”ä¸‹æ¢
- `fsm_run_close_gripper()`: é—­åˆå¤¹çˆª
- `fsm_run_lift()`: ç¬›å¡å°”æŠ¬å‡

### 6. å¤±è´¥é‡è¯•æœºåˆ¶
- `fsm_fail_to()` å‡½æ•°å¤„ç†å¤±è´¥
- æœ€å¤šé‡è¯•3æ¬¡è§„åˆ’å¤±è´¥
- è¶…å‡ºé‡è¯•æ¬¡æ•°è¿›å…¥ABORT_SAFE

### 7. å®‰å…¨ä¸­æ­¢
`fsm_do_abort_safe()` æ‰§è¡Œï¼š
- æ¾å¼€å¤¹çˆª
- æ¸…ç†åœºæ™¯ç¢°æ’å¯¹è±¡
- å‘å¸ƒçŠ¶æ€

## ä¼˜ç‚¹
1. **éé˜»å¡å›è°ƒ**: å›è°ƒåªåšç›®æ ‡æ›´æ–°ï¼Œä¸é˜»å¡è®¢é˜…çº¿ç¨‹
2. **åˆ†æ®µæ‰§è¡Œ**: æ¯ä¸ªé˜¶æ®µç‹¬ç«‹ï¼Œä¾¿äºè°ƒè¯•å’Œé‡è¯•
3. **ä¼˜é›…é‡è¯•**: å¤±è´¥å¯ä»¥å›é€€åˆ°ä¸Šä¸€çŠ¶æ€é‡è¯•
4. **ç›®æ ‡ç¨³å®šæ€§**: ç­‰å¾…ç›®æ ‡ç¨³å®šåå†æ‰§è¡Œï¼Œé¿å…è¿½é€ç§»åŠ¨ç›®æ ‡
5. **æ€¥åœå“åº”**: å®šæ—¶å™¨tickä¼šæ£€æŸ¥æ€¥åœæ ‡å¿—ï¼ŒåŠæ—¶å“åº”

## çŠ¶æ€è½¬æ¢å›¾
```
IDLE -> WAIT_TARGET_STABLE (æ”¶åˆ°ç›®æ ‡)
WAIT_TARGET_STABLE -> OPEN_GRIPPER (ç›®æ ‡ç¨³å®š)
OPEN_GRIPPER -> PREGRASP (å¤¹çˆªæ‰“å¼€)
PREGRASP -> ALIGN (åˆ°è¾¾é¢„æŠ“å–ä½ç½®)
ALIGN -> DESCEND (å§¿æ€å¯¹é½)
DESCEND -> CLOSE_GRIPPER (ä¸‹æ¢å®Œæˆ)
CLOSE_GRIPPER -> LIFT (å¤¹çˆªé—­åˆ)
LIFT -> DONE (æŠ¬å‡å®Œæˆ)
DONE -> IDLE (æ¸…ç†å®Œæˆ)

å¤±è´¥/æ€¥åœ -> ABORT_SAFE -> IDLE
```

## ç¼–è¯‘éªŒè¯
```bash
cd /home/huzy/grasp_perception
source /opt/ros/humble/setup.bash
colcon build --packages-select m5_grasp
```
ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯ã€‚

## ç½‘é¡µå¯è§†åŒ–æ›´æ–°
åŒæ­¥æ›´æ–°äº† `simulator/web/index.html`ï¼Œæ”¯æŒFSMçŠ¶æ€æ˜¾ç¤ºï¼š

### æ–°å¢FSMæ­¥éª¤å®šä¹‰
```javascript
const FSM_GRASP_STEPS = [
    { id: 'wait_stable', name: 'ç­‰å¾…ç›®æ ‡ç¨³å®š', state: 'WAIT_TARGET_STABLE' },
    { id: 'open_gripper', name: 'æ‰“å¼€å¤¹çˆª', state: 'OPEN_GRIPPER' },
    { id: 'pregrasp', name: 'é¢„æŠ“å–ä½ç½®', state: 'PREGRASP' },
    { id: 'align', name: 'å¯¹é½å§¿æ€', state: 'ALIGN' },
    { id: 'descend', name: 'ä¸‹æ¢', state: 'DESCEND' },
    { id: 'close_gripper', name: 'é—­åˆå¤¹çˆª', state: 'CLOSE_GRIPPER' },
    { id: 'lift', name: 'æŠ¬å‡', state: 'LIFT' }
];
```

### åŠŸèƒ½æ›´æ–°
1. **FSMçŠ¶æ€è§£æ**: è¯†åˆ« `FSM:` å‰ç¼€çš„çŠ¶æ€æ¶ˆæ¯
2. **çŠ¶æ€åç§°æ˜ å°„**: `FSM_STATE_NAMES` æä¾›è‹±æ–‡åˆ°ä¸­æ–‡çš„è½¬æ¢
3. **çŠ¶æ€é¢œè‰²åŒºåˆ†**:
   - æ©™è‰²: ç­‰å¾…ç›®æ ‡ç¨³å®š
   - æµ…ç»¿è‰²: æ‰§è¡Œä¸­
   - ç»¿è‰²: å®Œæˆ
   - çº¢è‰²: ä¸­æ­¢
4. **æ­¥éª¤æ¡æ˜¾ç¤º**: è‡ªåŠ¨é€‰æ‹©FSMæˆ–MTCæ­¥éª¤åˆ—è¡¨
5. **çŠ¶æ€æ ‡è¯†**: FSMçŠ¶æ€æ˜¾ç¤ºæ—¶å¸¦æœ‰ ğŸ”„ å›¾æ ‡å‰ç¼€

## ä»£ç å®¡æŸ¥åçš„ä¿®å¤ï¼ˆ2026-01-21 è¡¥å……ï¼‰

### ä¿®å¤éšæ‚£1ï¼šé”æŒæœ‰æ—¶é—´è¿‡é•¿
**é—®é¢˜**ï¼š`fsm_run_xxx()`å‡½æ•°ä¸­æŒæœ‰`fsm_task_cache_mutex_`é”ç›´åˆ°`execute_mtc_task()`å®Œæˆï¼Œå¯èƒ½å¯¼è‡´æ­»é”ã€‚

**ä¿®å¤**ï¼šé”åªç”¨äºæ‹·è´cacheåˆ°å±€éƒ¨å˜é‡ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾ï¼š
```cpp
FSMTaskCache cache;
{
  std::lock_guard<std::mutex> lk(fsm_task_cache_mutex_);
  if (!fsm_task_cache_.valid) return false;
  cache = fsm_task_cache_;   // æ‹·è´åˆ°å±€éƒ¨å˜é‡
}
// åé¢å…¨éƒ¨ç”¨ cacheï¼Œä¸å†æŒé”
```

### ä¿®å¤éšæ‚£2ï¼šDESCENDæ–¹å‘åæ ‡ç³»
**é—®é¢˜**ï¼šåŸæ¥ä½¿ç”¨`planning_frame_`ï¼ˆä¸–ç•Œç³»ï¼‰ä¸‹æ¢ï¼Œåœ¨åŸºåº§å€¾æ–œæ—¶è¡Œä¸ºä¸ç›´è§‰ã€‚

**ä¿®å¤**ï¼šæ”¹ä¸ºä½¿ç”¨å·¥å…·ç³»ï¼ˆ`eef_link_`ï¼‰ä¸‹æ¢ï¼Œå¤¹çˆªæ²¿è‡ªèº«-Zæ–¹å‘ç›´çº¿æ’ä¸‹ï¼š
```cpp
direction.header.frame_id = eef_link_;  // å·¥å…·ç³»
direction.vector.z = -descend_distance;
```

### å¢å¼º1ï¼šç›®æ ‡è·³å˜ä¸­æ–­æ£€æµ‹
æ·»åŠ `fsm_check_target_valid()`å‡½æ•°ï¼Œåœ¨PREGRASP/ALIGN/DESCENDæ‰§è¡Œå‰æ£€æµ‹ï¼š
- ç›®æ ‡æ˜¯å¦è¿‡æœŸï¼ˆ>0.5sï¼‰
- ç›®æ ‡æ˜¯å¦è·³å˜ï¼ˆä½ç½®>3cm æˆ– yaw>10Â°ï¼‰
- å¦‚æœè·³å˜ï¼Œç«‹åˆ»å›åˆ°WAIT_TARGET_STABLE

### å¢å¼º2ï¼šå¤¹çˆªç­‰å¾…æœºåˆ¶
`fsm_run_open_gripper()`å’Œ`fsm_run_close_gripper()`æ·»åŠ å¯é…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿å‘½ä»¤æ‰§è¡Œå®Œæˆã€‚

### å¢å¼º3ï¼šSolutioné€‰æ‹©æ—¥å¿—
åœ¨`execute_mtc_task()`ä¸­æ·»åŠ æ‰€æœ‰è§£çš„costä¿¡æ¯æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•ã€‚

### å¢å¼º4ï¼šå‚æ•°åŒ–é˜ˆå€¼
å°†æ‰€æœ‰é˜ˆå€¼æ”¹ä¸ºROSå‚æ•°ï¼ˆå¯åœ¨yamlä¸­é…ç½®ï¼‰ï¼š
- `fsm.stable_position_threshold`: ä½ç½®ç¨³å®šé˜ˆå€¼ (é»˜è®¤1cm)
- `fsm.stable_yaw_threshold`: yawç¨³å®šé˜ˆå€¼ (é»˜è®¤5Â°)
- `fsm.target_stale_timeout`: ç›®æ ‡è¿‡æœŸè¶…æ—¶ (é»˜è®¤0.5s)
- `fsm.jump_position_threshold`: ä½ç½®è·³å˜é˜ˆå€¼ (é»˜è®¤3cm)
- `fsm.jump_yaw_threshold`: yawè·³å˜é˜ˆå€¼ (é»˜è®¤10Â°)
- `fsm.stable_window_size`: ç¨³å®šæ€§æ»‘çª—å¤§å° (é»˜è®¤5å¸§)
- `fsm.gripper_wait_ms`: å¤¹çˆªç­‰å¾…æ—¶é—´ (é»˜è®¤500ms)

## æ¨¡å—åŒ–é‡æ„ï¼ˆ2026-01-21 è¡¥å……ï¼‰

æŒ‰ç…§"æœ€å°åŒ–è¿ç§»é¡ºåº"å°†å·¨å‹ m5_grasp.cpp æ‹†åˆ†ä¸ºæ¨¡å—åŒ–ç»“æ„ï¼š

### æ–°å¢æ¨¡å—

1. **TargetTracker** (`fsm/target_tracker.hpp/cpp`)
   - ç›®æ ‡æ»¤æ³¢å’Œç¨³å®šæ€§åˆ¤å®š
   - æ¥å£ï¼š`push()`, `hasStableTarget()`, `getStableTarget()`, `isStale()`, `isJumping()`

2. **IGripper** (`hw/gripper_interface.hpp`)
   - å¤¹çˆªæŠ½è±¡æ¥å£
   - GripperController ç°åœ¨å®ç°æ­¤æ¥å£

3. **TaskContext** (`mtc/task_context.hpp`)
   - å°è£…MTCä»»åŠ¡éœ€è¦çš„å…±äº«é…ç½®å’Œèµ„æº
   - TaskTarget ç»“æ„ç”¨äºä¿å­˜è®¡ç®—åçš„ä»»åŠ¡ç›®æ ‡

4. **TaskFactory** (`mtc/task_factory.hpp/cpp`)
   - è´Ÿè´£æ„å»ºMTCä»»åŠ¡ï¼ˆmakePregrasp, makeAlign, makeDescend, makeLiftï¼‰
   - æ¯ä¸ªå‡½æ•°è¿”å›ç‹¬ç«‹çš„ mtc::Task

5. **ITaskRunner / TaskRunner** (`mtc/task_runner.hpp/cpp`)
   - ITaskRunner: æŠ½è±¡æ¥å£ï¼ŒFSMåªä¾èµ–æ­¤æ¥å£
   - TaskRunner: è´Ÿè´£plan + execute MTCä»»åŠ¡

6. **GraspFSM** (`fsm/grasp_fsm.hpp/cpp`)
   - çº¯çŠ¶æ€æœºé€»è¾‘
   - ä¸ç›´æ¥æ“ä½œMTC/MoveItï¼Œåªè°ƒç”¨æŠ½è±¡æ¥å£

### ç›®å½•ç»“æ„

```
m5_grasp/
  include/m5_grasp/
    fsm/
      target_tracker.hpp
      grasp_fsm.hpp
    mtc/
      task_context.hpp
      task_factory.hpp
      task_runner.hpp
    hw/
      gripper_interface.hpp
  src/
    fsm/
      target_tracker.cpp
      grasp_fsm.cpp
    mtc/
      task_context.cpp
      task_factory.cpp
      task_runner.cpp
```

### CMakeLists åº“ç»“æ„

- `m5_grasp_mtc_lib`: MTCä»»åŠ¡æ„å»ºå’Œæ‰§è¡Œ
- `m5_grasp_fsm_lib`: çŠ¶æ€æœºå’Œç›®æ ‡è·Ÿè¸ª
- ç°æœ‰åº“ä¿æŒä¸å˜

### è¿ç§»å®Œæˆ

âœ… å·²å®Œæˆ m5_grasp.cpp çš„å®Œå…¨é‡æ„ï¼š

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| m5_grasp.cpp | 454 | æ¨¡å—åŒ–ç‰ˆæœ¬ï¼Œåªè´Ÿè´£ROS2èµ„æºç®¡ç† |

**ä»£ç ç²¾ç®€ç‡ï¼š94%**ï¼ˆä»åŸæ¥çš„7557è¡Œç²¾ç®€åˆ°454è¡Œï¼‰

### æ–°ç‰ˆ m5_grasp.cpp çš„èŒè´£

1. **ROS2èµ„æºç®¡ç†**ï¼šè®¢é˜…/å‘å¸ƒ/Timer
2. **åˆå§‹åŒ–MoveItæ¥å£**ï¼šMoveGroupInterface, PlanningSceneInterface
3. **åè°ƒæ¨¡å—åŒ–ç»„ä»¶**ï¼š
   - TargetTrackerï¼šç›®æ ‡è·Ÿè¸ª
   - GraspFSMï¼šçŠ¶æ€æœºé€»è¾‘
   - TaskRunnerï¼šMTCä»»åŠ¡æ‰§è¡Œ
   - GripperControllerï¼šå¤¹çˆªæ§åˆ¶

### æ¨¡å—ä¾èµ–å…³ç³»

```
M5Grasp (Node)
    â”œâ”€â”€ TargetTracker (ç›®æ ‡è·Ÿè¸ª)
    â”œâ”€â”€ GraspFSM (çŠ¶æ€æœº)
    â”‚       â”œâ”€â”€ ITaskRunner (æŠ½è±¡æ¥å£)
    â”‚       â””â”€â”€ IGripper (æŠ½è±¡æ¥å£)
    â”œâ”€â”€ TaskRunner (MTCæ‰§è¡Œ)
    â”‚       â””â”€â”€ TaskFactory (ä»»åŠ¡æ„å»º)
    â””â”€â”€ GripperController (å¤¹çˆªå®ç°)
```

## åç»­ä¼˜åŒ–å»ºè®®
1. æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆgtestï¼‰æµ‹è¯• FSM/TargetTracker
2. æ·»åŠ è¶…æ—¶æœºåˆ¶ï¼šæ¯ä¸ªé˜¶æ®µè®¾ç½®æœ€å¤§æ‰§è¡Œæ—¶é—´
3. æ·»åŠ FSMçŠ¶æ€å›¾å¯è§†åŒ–ï¼šåœ¨ç½‘é¡µä¸Šæ˜¾ç¤ºçŠ¶æ€è½¬æ¢å›¾
4. æ·»åŠ ä¸–ç•Œç³»/å·¥å…·ç³»ä¸‹æ¢åˆ‡æ¢å‚æ•°
