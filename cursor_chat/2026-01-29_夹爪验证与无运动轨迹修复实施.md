# 夹爪验证与无运动轨迹修复实施总结

## 日期
2026-01-29

## 已完成项

### 1. makeAlign 臂-缆绳 ACM（此前已做）
- 文件：`src/m5_grasp/src/mtc/task_factory.cpp`
- 在 `makeAlign()` 中与 `makeDescend` 一致增加臂-缆绳 ACM（ModifyPlanningScene + allowCollisions），避免 CHOMP 在仅动 Joint4 时判臂-缆绳碰撞失败。

### 2. align 改用 JointInterpolationPlanner
- 文件：`src/m5_grasp/src/mtc/task_factory.cpp`
- `makeAlign()` 不再使用 `createOMPLPlanner()`（CHOMP），改为使用 `cached_joint_planner_`（JointInterpolationPlanner），与 pregrasp/descend 关节目标一致，避免 CHOMP 碰撞与无运动轨迹问题。

### 3. 夹爪闭合验证失败时 close() 返回 false
- 文件：`src/m5_grasp/src/execution/gripper_controller.cpp`
- 在 `closeToWidth()` 中：当验证误差 `error_gl > tolerance || error_gr > tolerance` 时，不再“仅告警仍 return true”，改为 **return false**，让 FSM 走闭合失败分支。

### 4. WAIT_GRIPPER 闭合超时进失败分支
- 文件：`src/m5_grasp/src/fsm/grasp_fsm.cpp`
- 在 `handleWaitGripper()` 中：当**等待闭合**（`!wait_gripper_open_ && !wait_gripper_abort_`）且**超时**时，不再 `transitionTo(LIFT)`，改为 `transitionTo(ABORT_SAFE)`，并打 WARN 日志“夹爪闭合等待超时，未到位，进入ABORT_SAFE”。

### 5. 无运动轨迹检测并缩短时长
- 文件：`src/m5_grasp/src/mtc/task_runner.cpp`
- 在 `fixTrajectoryTimestamps()` 内、稀疏化之后：对每条子轨迹计算首尾关节位置差 `max|first - last|`；若小于阈值 `NO_MOTION_THRESHOLD_RAD = 1e-4` rad，则视为**无运动轨迹**。
- 对无运动轨迹：只保留首尾两点，末点 `time_from_start` 设为 0.1s，避免 5s 空跑；并打 INFO 日志“[无运动轨迹] 子轨迹#N: 首尾差 max=…，时长缩短为 0.1s”。

## 构建
- `colcon build --packages-select m5_grasp` 已通过。

## 涉及文件
| 修改内容 | 文件 |
|----------|------|
| align 臂-缆绳 ACM + JointInterpolationPlanner | `src/m5_grasp/src/mtc/task_factory.cpp` |
| 闭合验证失败 return false | `src/m5_grasp/src/execution/gripper_controller.cpp` |
| 闭合超时 → ABORT_SAFE | `src/m5_grasp/src/fsm/grasp_fsm.cpp` |
| 无运动检测 + 时长 0.1s | `src/m5_grasp/src/mtc/task_runner.cpp` |
