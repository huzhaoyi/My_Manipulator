# 2026-02-04 Joint4 阶段间跳动修复

## 现象
流程：打开夹爪 → 预抓取 → 对齐姿态 → 下探 → 闭合夹爪。在不同阶段切换时 Joint4 会先动一下再回到固定位置，怀疑是各阶段求解出的关节目标不一致。

## 原因
- 各阶段（pregrasp、align、descend）是**分开**建 task、分别 plan/execute 的。
- 每个 task 的起始状态都来自 `addStartStateStageForCartesian`，即 **FixedState(joint_state_diag)** 或 CurrentState。
- **joint_state_diag** 有更新延迟时，下一阶段拿到的“当前状态”仍是上一阶段**执行前**的旧状态，Joint4 尚未到 `joint4_target`。
- 于是 align/descend 会规划“从错误的 Joint4 到 joint4_target”的轨迹，执行时就出现 Joint4 先动一下再到位。

预抓取、下探里已经用 `joint4_target` 覆盖了 IK 解里的 Joint4，**目标值**是统一的；问题出在**起始状态**不一致。

## 修改
1. **TaskFactory** 新增 `addStartStateFromArmJointMap(task, arm_joint_map)`：用给定的 arm 关节映射（如上一阶段的关节目标）构造 FixedState，gripper 仍从 diag 取；仅当 map 包含 arm 全部关节时使用。
2. **makeAlign**：若有 `target.pregrasp_joint_map`，优先用其作为起始状态，这样 align 起点 = 预抓取终点，Joint4 已是 `joint4_target`，align 只设 Joint4 目标就不会再规划 Joint4 运动；否则退回 `addStartStateStageForCartesian`。
3. **makeDescend**：同样优先用 `target.pregrasp_joint_map` 作为起始状态（与 align 终点一致），避免 diag 滞后导致下探起点错误。

## 涉及文件
- `src/m5_grasp/include/m5_grasp/mtc/task_factory.hpp`：声明 `addStartStateFromArmJointMap`。
- `src/m5_grasp/src/mtc/task_factory.cpp`：实现 `addStartStateFromArmJointMap`；makeAlign / makeDescend 中起始状态优先使用 `pregrasp_joint_map`。

## 验证
- `colcon build --packages-select m5_grasp` 通过。
