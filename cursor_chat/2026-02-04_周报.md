# 周报

**日期**: 2026-02-04

---

## 〇、按提问文档汇总（cursor_chat 提问→落实）

| 日期 | 提问/问题 | 落实/结论 |
|------|-----------|-----------|
| 2026-01-19 | **MTC 规划**：yaw 方向不变、Invalid Start State 首次失败、关节边界误判、全零状态规划失败 | 用 joint1_target 覆盖 IK；FixedState 后 enforceBounds()；关节限位加 1e-4 容差；预运动参数（后于 02-03 移除未用部分）。**关节限制**：按厂家新限位更新 URDF/代码（Joint2/3 至 -170°，Joint1/4 至 ±355°）。 |
| 2026-01-21 | **FSM 抓取**：回调阻塞、难做分段/重试、巨型 Task 失败难重来 | FSM 驱动：IDLE→WAIT_TARGET_STABLE→OPEN_GRIPPER→PREGRASP→ALIGN→DESCEND→CLOSE_GRIPPER→LIFT→DONE；目标稳定性、10Hz tick、拆小 Task、ABORT_SAFE/重试；锁与 DESCEND 工具系、目标跳变检测、参数化阈值。**模块化**：TargetTracker、IGripper、TaskContext、TaskFactory、TaskRunner、GraspFSM；m5_grasp.cpp 从 7557 行减至 454 行。 |
| 2026-01-27 | **move_group 无法获取关节状态**：Failed to fetch current robot state | joint_states QoS 改为 best_effort（ros2_controllers.yaml）；launch 增加 robot_state_topic_timeout；task_factory 中 getCurrentState 重试与超时增强；getCurrentStateSafe fallback 优化。 |
| 2026-01-28 | **joint_states QoS 与 MoveIt 一致** | m5_grasp 订阅改为 best_effort+volatile，与 MoveIt 一致；ros2_controllers.yaml 注释发布端现状与 override 说明。 |
| 2026-01-28 | **夹爪验证与对齐无运动轨迹**（计划） | 见 01-29 实施：闭合验证失败 return false、闭合超时→ABORT_SAFE；无运动轨迹检测+时长 0.1s；align 臂-缆绳 ACM + JointInterpolationPlanner。 |
| 2026-01-28 | **网页状态快一阶段、夹爪未全闭合** | 进入 WAIT_EXECUTION_RESULT 时发布正在执行的步骤（old_state）；axis5 映射 [-2505, 5]、闭合/打开角与 cable_grasp 一致，夹爪轨迹 7.5s、网页输入范围同步。 |
| 2026-01-29 | **夹爪到位判断、yaw=joint4、MTC controller、轨迹与 JSON 一致、rosout 重复注册** | isOpenToTarget/isClosedToTarget（容差 0.15）；yaw 直接 joint4；setControllerNamesForSolution；on_solution_before_send 发布修复后轨迹；TaskFactory 专用 node 建 PipelinePlanner。 |
| 2026-01-29 | **夹爪闭合验证未达目标仍成功、对齐无运动 5s 空跑** | closeToWidth 验证失败 return false；闭合超时→ABORT_SAFE；无运动检测+时长 0.1s；makeAlign ACM+JointInterpolationPlanner。 |
| 2026-02-02 | **FakeSystem 命名、夹爪未动就下一阶段、LIFT 无抬升** | name 改为 m5_robot；execute 后 400ms+打开到位判据；抬升差过小改用笛卡尔抬升。 |
| 2026-02-02 | **joint_state_broadcaster 空参数日志** | 删除 use_all_available_interfaces 时的 DEBUG 日志，行为不变。 |
| 2026-02-02 | **为何还要容差？应完全用稳定性** | 移除 gripper_tolerance_rad/verify_tolerance_rad 及容差比较；仅用 last_open_verified_stable_/last_close_verified_stable_。 |
| 2026-02-03 | **UDP 发不出去** | 连接后按周期发送，不依赖“先收反馈”。 |
| 2026-02-03 | **全零时先到预备点？若有则去除** | 确认无执行逻辑，仅遗留参数；删除 auto_move_to_ready、ready_joint*、near_zero_threshold。 |
| 2026-02-03 | **去除地面障碍、视觉可发负 z** | add_ground_plane 默认 false，启动移除 ground_plane；position.z 不限制，可为负。 |

---

## 一、本周完成的工作

### 1. 硬件与通信

- **UDP 发不出去修复**（2026-02-03）  
  - 现象：系统能编译但 UDP 发不出去。  
  - 原因：`m5_hardware` 中只有收到反馈后才发送命令，导致“先有反馈才发”的死锁。  
  - 修改：`m5_hardware_interface.cpp` 中连接建立后按固定周期（50Hz）发送，不再依赖是否已收过反馈。

- **FakeSystem 命名为 m5_robot**（2026-02-02）  
  - `m5.urdf.xacro` / `m5.ros2_control.xacro` 中 `name="FakeSystem"` 改为 `name="m5_robot"`，与 M5 实机 UDP 接口命名一致。

- **移除 joint_state_broadcaster 空参数日志**（2026-02-02）  
  - `joint_state_broadcaster.cpp` 在 `use_all_available_interfaces()` 为真时去掉原 DEBUG 日志，行为不变。

### 2. 夹爪与 FSM

- **移除夹爪容差，完全采用稳定性判断**（2026-02-02）  
  - 到位判断改为仅依据反馈稳定性（连续采样变化小于阈值），删除 `gripper_tolerance_rad`、`verify_tolerance_rad` 等容差参数与逻辑。  
  - 打开/闭合均做稳定性验证，通过 `last_open_verified_stable_` / `last_close_verified_stable_` 供 FSM 消费。

- **夹爪“还没动就下一阶段”修复**（2026-02-02）  
  - `gripper_controller.cpp`：execute 返回 SUCCESS 后固定等待 400ms 再做稳定性采样；打开路径增加“反馈接近打开目标”的判据，避免未动但稳定被当成打开完成。

- **LIFT 无抬升修复**（2026-02-02）  
  - `task_factory.cpp`：抬升关节目标与起始差异过小（&lt;0.5°）时改用笛卡尔抬升，避免轨迹 1 点、duration=0。

- **夹爪闭合验证与超时**（2026-01-29）  
  - 闭合验证未达目标时 `closeToWidth()` 返回 false；WAIT_GRIPPER 闭合超时进入 ABORT_SAFE 而非 LIFT。

### 3. MTC / 轨迹与场景

- **去除全零先到预备点功能**（2026-02-03）  
  - 删除未使用的 `auto_move_to_ready`、`ready_joint1~4`、`near_zero_threshold` 等参数（cable_grasp.yaml、parameter_manager、grasp_types.hpp），流程保持：打开夹爪 → 直接预抓取 → align/descend/…

- **去除地面障碍与视觉负 z**（2026-02-03）  
  - `add_ground_plane` 默认 false，启动时移除 `ground_plane` 碰撞体（支架测试模式）。  
  - 视觉位姿不限制 z，允许 position.z 为负（支架/基座下方）。

- **对齐无运动轨迹与夹爪相关**（2026-01-29）  
  - makeAlign 增加臂-缆绳 ACM，align 改用 JointInterpolationPlanner。  
  - `task_runner.cpp` 中无运动轨迹检测（首尾关节差 &lt; 阈值）：时长缩短为 0.1s，避免 5s 空跑。

- **MTC stage controller 与轨迹发布**（2026-01-29）  
  - 为 solution 设置 `controller_names`（arm/gripper），消除 “stage does not have any controllers specified” 警告。  
  - 通过 `on_solution_before_send` 将修复后轨迹发布到网页，与执行轨迹一致。

- **yaw = joint4、rosout 重复注册**（2026-01-29）  
  - yaw 直接对应 joint4，去掉 `grasp_yaw_add` 叠加。  
  - TaskFactory 使用专用 MTC planning node 创建 PipelinePlanner，避免 Publisher already registered。

---

## 二、遇到的问题与解决

| 问题 | 原因/处理 |
|------|-----------|
| UDP 发不出去 | 发送条件依赖“已收反馈”，改为连接后按周期发送。 |
| 夹爪未动就进入下一阶段 | 增加 execute 后 400ms 等待 + 打开“接近目标”判据，仅稳定性通过且到位才转出。 |
| LIFT 无抬升（1 点、duration=0） | 抬升关节与起始差过小时改用笛卡尔抬升。 |
| 对齐轨迹 5s 空执行 | 无运动轨迹检测 + 时长改为 0.1s。 |
| 闭合未到位仍进 LIFT | 验证失败 return false，闭合超时进 ABORT_SAFE。 |
| 夹爪仍依赖容差 | 全面改为稳定性判断，移除所有容差参数。 |

---

## 三、涉及的主要文件/模块

- **m5_hardware**：`m5_hardware_interface.cpp`（UDP 发送逻辑）
- **m5_grasp**：`task_factory.cpp`、`task_runner.cpp`、`task_context.cpp`、`gripper_controller.cpp`、`grasp_fsm.cpp`、`parameter_manager`、`m5_grasp.cpp`、`grasp_types.hpp`、`cable_grasp.yaml`
- **m5_moveit_config**：`m5.urdf.xacro`、`m5.ros2_control.xacro`
- **ros2_controllers**：`joint_state_broadcaster.cpp`

---

## 四、建议的后续验证

1. 抓取流程：确认 LIFT 有实际抬升轨迹，夹爪打开约 400ms 后再判稳且需接近张开目标。  
2. 启动日志：出现 `Loading hardware 'm5_robot'`。  
3. 支架测试：无地面碰撞体，视觉可发负 z。  
4. 真机：UDP 连接后能正常收发；夹爪闭合仅凭稳定性判定，超时走 ABORT_SAFE。
